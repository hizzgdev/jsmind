<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>jsMind</title>
        <link type="text/css" rel="stylesheet" href="../style/jsmind.css" />
        <style type="text/css">
            #jsmind_container {
                width: 800px;
                height: 500px;
                border: solid 1px #ccc;
                /*background:#f4f4f4;*/
                background: #f4f4f4;
            }
        </style>
    </head>
    <body>
        <input type="file" onchange="load_file(this);" />
        <button onclick="save_nodetree();">nodetree</button>
        <button onclick="replay();">replay</button>
        <button onclick="demo_add_nodes();">添加多个节点</button>
        <button onclick="demo_add_nested_nodes();">添加嵌套节点</button>
        <button onclick="demo_add_invalid_nodes();">测试失败场景</button>
        <div id="jsmind_container"></div>
        <script type="text/javascript" src="../es6/jsmind.js"></script>
        <script type="text/javascript" src="../es6/jsmind.draggable-node.js"></script>
        <script type="text/javascript" src="../features/jsmind.shell.js"></script>
        <script type="text/javascript">
            var _jm = null;
            function load_jsmind() {
                var mind = {
                    meta: {
                        name: 'demo',
                        author: 'hizzgdev@163.com',
                        version: '0.2',
                    },
                    format: 'node_array',
                    data: [
                        { id: 'root', isroot: true, topic: 'jsMind' },

                        { id: 'sub1', parentid: 'root', topic: 'sub1' },
                        { id: 'sub11', parentid: 'sub1', topic: 'sub11' },
                        { id: 'sub12', parentid: 'sub1', topic: 'sub12' },
                        { id: 'sub13', parentid: 'sub1', topic: 'sub13' },

                        { id: 'sub2', parentid: 'root', topic: 'sub2' },
                        { id: 'sub21', parentid: 'sub2', topic: 'sub21' },
                        { id: 'sub22', parentid: 'sub2', topic: 'sub22' },

                        { id: 'sub3', parentid: 'root', topic: 'sub3' },
                    ],
                };
                var options = {
                    container: 'jsmind_container',
                    editable: true,
                    theme: 'primary',
                    log_level: 'debug',
                    shortcut: {
                        handles: {
                            test: function (j, e) {
                                console.log(j);
                            },
                        },
                        mapping: {
                            test: 89,
                        },
                    },
                    view: {
                        expander_style: 'char',
                    },
                };
                _jm = new jsMind(options);
                _jm.show(mind);
                // jm.set_readonly(true);
                // var mind_data = jm.get_data();
                // alert(mind_data);
            }

            function load_file(fi) {
                var files = fi.files;
                if (files.length > 0) {
                    var file_data = files[0];
                    jsMind.util.file.read(file_data, function (freemind_data, jsmind_name) {
                        var mind = jsmind_data;
                        if (!!mind) {
                            _jm.show(mind);
                        } else {
                            console.error('can not open this file as mindmap');
                        }
                    });
                }
            }

            function save_nodetree() {
                var mind_data = _jm.get_data('node_tree');
                console.log(mind_data);
            }

            function replay() {
                var shell = _jm.shell;
                if (!!shell) {
                    shell.replay();
                }
            }

            // 演示 add_nodes 方法的基础用法
            function demo_add_nodes() {
                if (!_jm) {
                    alert('请先加载思维导图');
                    return;
                }
                
                console.log('=== 演示 add_nodes 基础用法 ===');
                
                // 获取根节点
                var root = _jm.get_root();
                
                // 准备要添加的节点数据
                var nodes_data = [
                    {
                        id: 'batch_node_1',
                        topic: '批量节点1',
                        data: { 'background-color': '#ffcc00' },
                        direction: 'right'
                    },
                    {
                        id: 'batch_node_2', 
                        topic: '批量节点2',
                        data: { 'foreground-color': '#ff0000' },
                        direction: 'left'
                    },
                    {
                        id: 'batch_node_3',
                        topic: '批量节点3',
                        direction: 'right'
                    }
                ];
                
                // 调用 add_nodes 方法
                var result = _jm.add_nodes(root, nodes_data);
                
                console.log('添加结果:', result);
                console.log('成功添加了', result.length, '个节点');
                
                if (result.length > 0) {
                    alert(`成功添加了 ${result.length} 个节点！`);
                } else {
                    alert('节点添加失败，请查看控制台日志');
                }
            }
            
            // 演示 add_nodes 方法添加嵌套节点
            function demo_add_nested_nodes() {
                if (!_jm) {
                    alert('请先加载思维导图');
                    return;
                }
                
                console.log('=== 演示 add_nodes 嵌套节点 ===');
                
                // 获取根节点
                var root = _jm.get_root();
                
                // 准备嵌套节点数据
                var nested_nodes_data = [
                    {
                        id: 'parent_node_1',
                        topic: '父节点1',
                        data: { 'background-color': '#99ccff' },
                        direction: 'right',
                        children: [
                            {
                                id: 'child_1_1',
                                topic: '子节点1-1',
                                data: { 'foreground-color': '#0066cc' }
                            },
                            {
                                id: 'child_1_2',
                                topic: '子节点1-2',
                                children: [
                                    {
                                        id: 'grandchild_1_2_1',
                                        topic: '孙节点1-2-1'
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        id: 'parent_node_2',
                        topic: '父节点2',
                        direction: 'left',
                        children: [
                            {
                                id: 'child_2_1',
                                topic: '子节点2-1'
                            }
                        ]
                    }
                ];
                
                // 调用 add_nodes 方法
                var result = _jm.add_nodes(root, nested_nodes_data);
                
                console.log('嵌套节点添加结果:', result);
                console.log('总共添加了', result.length, '个节点（包括所有层级）');
                
                if (result.length > 0) {
                    alert(`成功添加了 ${result.length} 个节点（包括嵌套子节点）！`);
                } else {
                    alert('嵌套节点添加失败，请查看控制台日志');
                }
            }
            
            // 演示 add_nodes 方法的失败场景和原子性
            function demo_add_invalid_nodes() {
                if (!_jm) {
                    alert('请先加载思维导图');
                    return;
                }
                
                console.log('=== 演示 add_nodes 失败场景和原子性 ===');
                
                // 获取根节点
                var root = _jm.get_root();
                
                // 准备包含无效数据的节点列表
                var invalid_nodes_data = [
                    {
                        id: 'valid_node_1',
                        topic: '有效节点1'
                    },
                    {
                        // 缺少 id 字段 - 这会导致失败
                        topic: '无效节点（缺少ID）'
                    },
                    {
                        id: 'valid_node_2',
                        topic: '有效节点2'
                    },
                    {
                        id: 'root', // 使用已存在的ID - 这会导致失败
                        topic: '无效节点（ID冲突）'
                    }
                ];
                
                console.log('尝试添加包含无效数据的节点列表...');
                console.log('输入数据:', invalid_nodes_data);
                
                // 调用 add_nodes 方法
                var result = _jm.add_nodes(root, invalid_nodes_data);
                
                console.log('失败场景测试结果:', result);
                console.log('由于原子性保证，即使有部分有效节点，最终添加数量为:', result.length);
                
                if (result.length === 0) {
                    alert('✅ 原子性测试成功！\n由于存在无效节点，所有节点都未被添加。\n请查看控制台查看详细日志。');
                } else {
                    alert('❌ 原子性测试失败！部分节点被添加了。');
                }
            }

            load_jsmind();
        </script>
    </body>
</html>
